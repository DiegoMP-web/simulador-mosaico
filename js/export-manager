// js/export-manager.js
// Exporta el primer SVG visible dentro de #preview-grid a PNG (sin librerías)

window.ExportManager = {
  async exportPNG({ containerId = "preview-grid", fileName = "mosaico.png" } = {}) {
    const container = document.getElementById(containerId);
    if (!container) {
      alert("No encuentro el área del mosaico para exportar.");
      return;
    }

    const svg = container.querySelector("svg");
    if (!svg) {
      alert("No hay un SVG para exportar todavía. Selecciona un modelo primero.");
      return;
    }

    const serializer = new XMLSerializer();
    let svgText = serializer.serializeToString(svg);

    // Asegura namespaces
    if (!svgText.includes('xmlns="http://www.w3.org/2000/svg"')) {
      svgText = svgText.replace("<svg", '<svg xmlns="http://www.w3.org/2000/svg"');
    }
    if (!svgText.includes('xmlns:xlink="http://www.w3.org/1999/xlink"')) {
      svgText = svgText.replace("<svg", '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
    }

    const blob = new Blob([svgText], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const img = new Image();
    img.onload = () => {
      const scale = 2; // más nítido
      const w = Math.max(1, img.width) * scale;
      const h = Math.max(1, img.height) * scale;

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);

      URL.revokeObjectURL(url);

      canvas.toBlob((pngBlob) => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(pngBlob);
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }, "image/png");
    };

    img.onerror = () => {
      URL.revokeObjectURL(url);
      alert("No se pudo exportar. Si tu SVG tiene imágenes externas, hay que incrustarlas.");
    };

    img.src = url;
  }
};
